---
title: "STAT 184 Final Project"
author: "Zinuo Jia, Alexander Kim"
date: "12/17/2019"
output: html_notebook
---


### Front Matter

```{r}
# clean up the RStudio environment 
rm(list = ls())
# load all packages needed
library(mosaic)
library(DataComputing)
library(tidyverse)
library(lubridate)
library(leaflet)
library(rvest)
library(readr)

```

Importing Data

Descrition for our primary data:
This dataset contains a list of video games with sales greater than 100,000 copies. It was generated by a scrape of vgchartz.com.
Fields include  
Rank - Ranking of overall sales  
Name - The games name  
Platform - Platform of the games release (i.e. PC,PS4, etc.)  
Year - Year of the game's release  
Genre - Genre of the game  
Publisher - Publisher of the game  
NA_Sales - Sales in North America (in millions)  
EU_Sales - Sales in Europe (in millions)  
JP_Sales - Sales in Japan (in millions)  
Other_Sales - Sales in the rest of the world (in millions)  
Global_Sales - Total worldwide sales.  

The script to scrape the data is available at https://github.com/GregorUT/vgchartzScrape. It is based on BeautifulSoup using Python. There are 16,598 records. 2 records were dropped due to incomplete information.
```{r}
#Source data "vgsales.csv" downloaded from "Kaggle.com/dataset"
#vgsales.csv already uploaded in the repo
vgsales <- read_csv("vgsales.csv")
#load source data "vgconsole" from "https://en.wikipedia.org/wiki/List_of_best-selling_game_consoles" 
page <- "https://en.wikipedia.org/wiki/List_of_best-selling_game_consoles" 
tableList <- page %>%
  read_html() %>%
  html_nodes(css = "table") %>%
  html_table(fill = TRUE)
vgconsole<-tableList[[1]]
vgconsole$Ref. <- NULL #took out the Ref. column that has no value
head(vgconsole)
head(vgsales)
```

### Introduction 
By importing the data source, we introduce our research question:" What are the factors that can influence global sales for video games?"
We can observe our primary data source by using the function `str`  
```{r}
str(vgsales)
```
In this project, we will only analyze the Global sales of each video game.  
```{r}
#Clean up variables that we do not care to keep the data simple. Use vgsales1 as the data set that we will analyze.
vgsales1 <- 
  vgsales%>%
  select(Rank,Name,Platform,Year,Genre,Publisher,Global_Sales)
```

##### Clean the Data Source
By checking our data, we can see that we need to clean both data set so we can easily analyze them. Let us first clean the secondary dataset.  
Firstly, we can take a look at the data set.

```{r}
str(vgconsole)
head(vgconsole)
```
We start to clean the data by rename the variables.
```{r}
names(vgconsole)[c(3,4)] <- c("Released","UnitsSold")
```

From the result, we would like to change the character variable "Unit sold" and "Released" into numerical variable. There are some estimated value like "80â€“82 million(estimate)" which we will just take its average value, 81 million. 
```{r}
#clean our "million" and other character using regular expression
vgconsole <-
  vgconsole%>%
  mutate(UnitsSold = gsub(pattern = ">", replacement = "", UnitsSold))%>%
  mutate(UnitsSold = gsub(pattern = "\\million|\\(estimate)", replacement = "", UnitsSold))%>%
   mutate(UnitsSold = gsub(pattern = "\\ ", replacement = "", UnitsSold))
#change three of the data into their mean values. Note that at this point the variable "UnitsSold" is still in chracteristic.
vgconsole[10,4] = 81
vgconsole[23,4] = 12.5
vgconsole[24,4] = 11.5
#There is one combined data which we will treat them as one case.
vgconsole[3,1:3] = c("Game Boy","Nintendo",1989)
#change variable type
vgconsole <-
  vgconsole%>%
  mutate(Released = readr::parse_number(as.character(Released)))%>%
  mutate(UnitsSold =readr::parse_number(as.character(UnitsSold)))
```
Then we can clean our primary data, since this data set is produced by other people for data analysis already, so we will only need to change the "year" variable into numerical variable.

```{r}
vgsales1 <-
  vgsales1%>%
  mutate(Year = as.numeric(as.character((Year))))
```


##### Building the model
Before we build our model, we need to transfer all our required variables and put them in one dataset. To do this, we can combine our two data source by a joining function, but note that, in our secondary data source, We use full name of platform which is different from our primary data. 
We can combine two data source by creating a data frame that matches platform names.  
```{r}
#Create a list of full platform names
PlatformFull <-
  vgconsole%>%
  select(Platform)
PlatformFull
```
```{r}
#Create a list of short platform names
PlatformAbb <-
  vgsales%>%
  group_by(Platform)%>%
  summarise(count = n())%>%
  select(Platform)
names(PlatformAbb) <- "PlatformAbb"
PlatformAbb
```


```{r}
Platform2 <- 
  PlatformAbb %>%
  mutate(Platform = c("Atari 2600","3D0 Interactive Multiplayer","Nintendo 3DS", "Dreamcast","Nintendo DS", "Game Boy","Game Boy Advance", "GameCube","Sega Genesis", "Sega Game Gear","Nintendo 64", "Nintendo Entertainment System","Neo Geo", "Personal Computer","NEC PC-FX", "PlayStation","PlayStation 2", "PlayStation 3","PlayStation 4", "PlayStation Portable","PlayStation Vita", "Sega Saturn","Nintendo Supplemental Computing Device", "Super Nintendo Enteratainment System","TurboGrafx-16", "Wii","Wii U", "WonderSwan","Xbox 360", "Xbox","Xbox One"))
head(Platform2)
```

Now we have a data frame with platform names matched with their abbreviation. We can use two join function to combine two datasets, and again we will select only the variables that we need.
```{r}
vgconsole <-
vgconsole %>%
  inner_join(Platform2)%>%
  select(PlatformAbb,Released,UnitsSold)
head(vgconsole)
```
Since we are analyzing possible variables that may influence video game sales, here is one more variable which might be a factor. By calculating the mean sales by each platform, we may find it influencial to games total sales.
```{r}
MeanbyPlatform<-
vgsales1 %>%
  group_by(Platform)%>%
  summarise(MeanSale = mean(Global_Sales))%>%
  arrange(desc(MeanSale))
head(MeanbyPlatform)
```
Now we have transformed our secondary datas into the form that we need. We now combine this new data with our primary dataset.
```{r}
vgsales1 <-
vgsales1%>%
  left_join(vgconsole,by=c("Platform" = "PlatformAbb"))%>%
  left_join(MeanbyPlatform)
head(vgsales1)
```
Now we have all the variables we need and we can start to build our model using Global sales as a response variable and all other variables as predictor variables. We can address a linear model for all our numerical variables.

```{r}
attach(vgsales1)
MLR <- lm(Global_Sales~Released+UnitsSold+MeanSale+Year)
detach(vgsales1)
summary(MLR)
```
Since all the coefficient has a p-value smaller than 0.05, we think this model is significant with a linear formula:  
$Sales = 3.7202 +0.0524*Released+0.0006*UnitsSold+1.0401*MeanSale-0.05423*Year$

In the Residuals vs Fitted graph, the residuals are cluttered around the 0 line. This suggests that the assumption that the relationship is linear is reasonable. 
For the Normal Q-Q graph, the majority follow a linear relationship. However, starting at the theoretical category of 2, the points start to deviate from a linear relationship. This is somewhat concerning that that it can be assumed the data is not normally distributed. 
In the Scale-Location graph, this represent whether or not the residuals are spread equally along the ranges of the predictors. Because the points are clustered into two groups, it may seem that the residuals are not equal in variance, however, because the red smooth line has a fairly equal slope i.e. a horizontal slope, it can be assumed that the residuals appear to be randomly spread.
However, in the Residuals vs Leverage graph, because all points are below the Cook's Distance line (although point 2 is very close) there are no influential cases. Therefore, there are no outliers that are significantly influential. 
```{r}
plot(MLR)
abline(MLR)
```

Time series graph of platforms' global sales in millions. 
```{r}
vgsales2 <- vgsales1 %>%
  group_by(Platform, Year) %>%
  summarise(total=sum(Global_Sales))
vgsales2
time <- ggplot(data=vgsales2, aes(x=Year, y=total, col=Platform)) +geom_line()
time
```

Seeing which platform had the greatest sale globally. 
```{r}
vgsales %>%
  group_by(Platform) %>%
  filter(rank(desc(Global_Sales))==1)%>%
  ggplot(aes(x=reorder(Platform,-Global_Sales),y=Global_Sales ))+
  geom_bar(stat='identity',position='stack', width=.9)+
  theme(axis.text.x=element_text(angle=60,hjust=1)) 
```

Most Sold Game in terms of Global Sales
```{r}
  vgsales %>%
  group_by(Platform) %>%
  filter(rank(desc(Global_Sales))==1)%>%
  ggplot(aes(x=reorder(Name,-Global_Sales),y=Global_Sales ))+
  geom_bar(stat='identity',position='stack', width=.9) +
  theme(axis.text.x=element_text(angle=60,hjust=1)) +
  xlab("Game Title") +
  ylab("Global Sales")
```

